/*

Do the main menu, some more small stuff to do

Do difficulties:
Different speeds
Different gaps
Bigger random on the y position
*/

#include <stm32f031x6.h>
#include "display.h"
#include <stdio.h>
#include "prbs.h"
#include "serial.h"
#include <stdint.h>
#include <stddef.h>
#define BLUE 33020
#define MINSCREENX 0
#define MINSCREENY 0
#define MAXSCREENX 128
#define MAXSCREENY 160
#define PIPEWIDTH 14
#define PIPEHEIGHT 4
#define PIPECHUNKHEIGHT 20
#define PIPEFILLERHEIGHT 1
#define BIRDWIDTH 17
#define BIRDHEIGHT 12
#define bHeight 74
#define bWidth 32
#define bStart 65
#define FILLSTART 2
#define FILLEND 3
#define cornerSIZE 12
#define cursorWidth 10
#define cursorHeight 9
#define GREEN 57383
#define RED 7936
#define WHITE 65535
#define BLACK 0
#define ORANGE 48932
#define CRASHINDEX 4
#define STATSINDEX 3 // menu index for the stats menu
#define OPTIONINDEX 2 // menu index for the options menu
#define DIFFINDEX 1 // menu index for the difficulty menu
#define MENUINDEX 0 // menu index for the main menu


struct pipe{
	int x;
	uint16_t y;
	int oldx;
	uint16_t oldy;

	uint16_t speed;
	uint16_t start;
	uint16_t gap;
	
	int active;
};

struct bird{
	uint16_t x;
	int y;

	uint16_t oldx;
	int oldy;

	uint16_t jumpStrength;
	float gravity;
	float birdVelocity;
};

struct images{
	const uint16_t *pipeIMG;
	const uint16_t *backgroundIMG;
	const uint16_t *pipeStartIMG;
	const uint16_t *birdIMG;
};

struct difficulty{
	int pipesAmt;
	uint8_t start;
	uint8_t end;
	float spawnGap;
	uint16_t gap;
	uint8_t active;
	uint8_t oldActive;
};

struct flags{
	int gameOverText;
	int dayNight;
	int soundOnOff;
	int flappingAnim;
	uint8_t runOnce;
	uint8_t gameState;
};

struct menu{
	int menuSelection; // The current selection for each menu option
	int oldSelection; // Old selection for the menu options
	int menuX; // X value for where to start generating menu block
	int menuY; // Y value for where to start generating menu block
	int menuWidth; // Width of menu block
	int menuHeight; // Height of menu block
	int baseX; // Base x value of where to use printText, stays the same unless drawing cursor
	int baseY; // Base y value of where to use printText, changes based on textIncrement * i
	int cursorGap;
	int textHeight; // Height of printText() in pixels
	int textGap; // Gap in pixels between each text drawn by printText()
	int textIncrement; // The spacing in pixels between any two texts drawn by printText()
	const char **textUsed; // Pointer to the array of strings to be used
	int sizeOfText; // Size of the menuText array
	uint8_t changeMenu;
};

struct stats{
	uint16_t highScore;
	uint16_t score;
	uint16_t oldScore;
	uint16_t totScore;
	uint16_t amtCrashed;
};

void initClock(void);
void initSysTick(void);
void SysTick_Handler(void);
void delay(volatile uint32_t dly);
void setupIO();
void enablePullUp(GPIO_TypeDef *Port, uint32_t BitNumber);
void pinMode(GPIO_TypeDef *Port, uint32_t BitNumber, uint32_t Mode);
volatile uint32_t milliseconds;

uint8_t enterPressed();
uint8_t upPressed();
uint8_t downPressed();
uint8_t leftPressed();
uint8_t rightPressed();
uint8_t anyButtonPressed();

uint8_t enterPressedOnce();

void initPipe(struct pipe *pipes);
void initBird(void);
void initBackground();
void initDifficulty();
void initDayNight();
void initMenu();
void initFlags();
void initImages();

void menuInterface();
void optionsMenu();
void updateOption(int currMenu, int currSelection);
void menuNavigation(uint8_t i);
void drawMenu(uint8_t i);
int getFlagColour(int currMenu, int currSelection);

void gameLoop();
void gameOverText(struct pipe *pipes);
void restartGame(struct pipe *pipes);
int birdLogic(struct pipe *pipes);


void drawTopPipe(struct pipe *pipes, uint8_t i);
void drawBottomPipe(struct pipe *pipes, uint8_t i);
void drawPipe(struct pipe *pipes);
void endOfPipeCheck(struct pipe *pipes);
void activatePipes(struct pipe *pipes);
uint8_t checkCollision(struct pipe *pipes);
uint8_t rectsOverlap(uint16_t ax1, uint16_t ax2, uint16_t ay1, uint16_t ay2, uint16_t bx1, uint16_t bx2, uint16_t by1, uint16_t by2);

void fillBackground(uint16_t x,uint16_t y,uint16_t width, uint16_t height);
void putImageV2(uint16_t x, uint16_t y, uint16_t width, uint16_t height, const uint16_t *Image, uint8_t hOrientation, uint8_t vOrientation);
void addBoundingBox(uint8_t x, uint16_t y, uint16_t colour, uint8_t thickness, uint8_t sizeOfprintText);
uint16_t getBackgroundPixel(uint16_t screenX, uint16_t screenY);
void putPipe(uint16_t x, uint16_t y, uint16_t width, uint16_t height, const uint16_t *Image);
void drawCrashedBird();


struct difficulty difficulty;
struct bird bird;
struct menu menu[5];
struct flags flags;
struct images images;
struct stats stats;


const uint16_t birdUp[]=
{
	5536,5536,5536,5536,5536,5536,2625,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,5536,5536,2625,2625,65422,65422,65422,2625,24575,24575,2625,5536,5536,5536,5536,5536,5536,5536,2625,65422,65422,65333,65333,2625,24575,24575,24575,24575,2625,5536,5536,5536,5536,2625,2625,2625,2625,65333,65333,65333,2625,56015,24575,24575,2625,24575,2625,5536,5536,2625,24575,24575,24575,24575,2625,65333,65333,2625,56015,24575,24575,2625,24575,2625,5536,5536,2625,24575,24575,24575,24575,24575,2625,65333,65333,2625,56015,24575,24575,24575,2625,5536,5536,2625,65422,24575,24575,24575,65422,2625,65333,65333,65333,2625,2625,2625,2625,2625,2625,5536,5536,2625,65422,65422,65422,2625,65333,65333,65333,2625,7937,7937,7937,7937,7937,7937,2625,5536,5536,2625,2625,2625,7212,7212,7212,2625,7937,2625,2625,2625,2625,2625,2625,5536,5536,5536,2625,7212,7212,7212,7212,7212,7212,2625,7937,7937,7937,7937,7937,2625,5536,5536,5536,5536,2625,2625,7212,7212,7212,7212,7212,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,
};

const uint16_t birdMid[]=
{
	5536,5536,5536,5536,5536,5536,2625,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,5536,5536,2625,2625,65422,65422,65422,2625,24575,24575,2625,5536,5536,5536,5536,5536,5536,5536,2625,65422,65422,65333,65333,2625,24575,24575,24575,24575,2625,5536,5536,5536,5536,5536,2625,65422,65333,65333,65333,65333,2625,56015,24575,24575,2625,24575,2625,5536,5536,5536,2625,65333,65333,65333,65333,65333,65333,2625,56015,24575,24575,2625,24575,2625,5536,5536,5536,2625,2625,2625,2625,2625,65333,65333,65333,2625,56015,24575,24575,24575,2625,5536,5536,2625,24575,24575,24575,24575,24575,2625,65333,65333,65333,2625,2625,2625,2625,2625,2625,5536,2625,65422,24575,24575,24575,65422,2625,65333,65333,2625,7937,7937,7937,7937,7937,7937,2625,5536,2625,2625,2625,2625,2625,7212,7212,2625,7937,2625,2625,2625,2625,2625,2625,5536,5536,5536,2625,7212,7212,7212,7212,7212,7212,2625,7937,7937,7937,7937,7937,2625,5536,5536,5536,5536,2625,2625,7212,7212,7212,7212,7212,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,
};

const uint16_t birdDown[]=
{
	5536,5536,5536,5536,5536,5536,2625,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,5536,5536,2625,2625,65422,65422,65422,2625,24575,24575,2625,5536,5536,5536,5536,5536,5536,5536,2625,65422,65422,65333,65333,2625,24575,24575,24575,24575,2625,5536,5536,5536,5536,5536,2625,65422,65333,65333,65333,65333,2625,56015,24575,24575,2625,24575,2625,5536,5536,5536,2625,65333,65333,65333,65333,65333,65333,2625,56015,24575,24575,2625,24575,2625,5536,5536,5536,2625,65333,65333,65333,65333,65333,65333,65333,2625,56015,24575,24575,24575,2625,5536,5536,5536,2625,2625,2625,2625,2625,65333,65333,65333,65333,2625,2625,2625,2625,2625,2625,5536,2625,65422,24575,24575,24575,65422,2625,65333,65333,2625,7937,7937,7937,7937,7937,7937,2625,2625,24575,24575,24575,24575,2625,7212,7212,2625,7937,2625,2625,2625,2625,2625,2625,5536,2625,24575,24575,65422,2625,7212,7212,7212,7212,2625,7937,7937,7937,7937,7937,2625,5536,5536,2625,2625,2625,2625,7212,7212,7212,7212,7212,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,
};

const uint16_t pipeStart[]=
{
	2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,56463,56463,7047,22911,30574,21854,12877,4165,3380,27692,18980,35356,2625,2625,56463,56463,7047,22911,30574,21854,12877,4165,3380,27692,18980,35356,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,
};

const uint16_t pipeStartNight[]=
{
	512,512,512,512,512,512,512,512,512,512,512,512,512,512,512,62277,62277,12861,28725,36388,27668,26891,18179,17666,41730,33281,49409,512,512,62277,62277,12861,28725,36388,27668,26891,18179,17666,41730,33281,49409,512,512,512,512,512,512,512,512,512,512,512,512,512,512,512,
};

const uint16_t pipeEnd[]=
{
	5536,2625,13142,55150,14719,39559,39030,46174,45389,60980,43820,10788,2625,5536,
};

const uint16_t pipeEndNight[]=
{
	5536,256,27411,60964,20789,45373,44844,60179,59395,9474,57857,24833,512,5536,
};

const uint16_t background[]=
{
	2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64471,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,64983,64983,64983,64983,64983,64983,64983,64983,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,64983,64983,64983,64983,64983,64983,64983,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,64983,64983,64983,64983,64983,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,64983,64983,64983,64983,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,64983,64983,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,64983,64983,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,16733,16733,16733,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,16733,16733,16733,16733,18301,18301,18301,18301,18301,16733,16733,16733,16733,16733,16733,16733,18301,18301,18301,18301,18301,18301,18301,16733,16733,18301,18301,18301,18301,18301,18301,16733,16733,16733,16733,16733,16733,18301,18301,18301,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,18301,18301,16733,16733,16733,16733,16733,16733,18301,18301,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,26182,26182,26182,26182,43599,43599,43599,26182,43599,43599,43599,26182,26182,26182,26182,26182,43599,43599,26182,26182,43599,26182,43599,43599,26182,26182,43599,43599,26182,43599,43599,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,19730,19730,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,19730,19730,19730,19730,19730,19730,26182,26182,19730,19730,19730,19730,26182,26182,19730,19730,19730,26182,26182,26182,19730,19730,19730,19730,26182,19730,19730,26182,26182,19730,19730,26182,19730,19730,12562,12562,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,12562,12562,12562,12562,12562,12562,19730,19730,12562,12562,12562,12562,19730,19730,12562,12562,12562,19730,19730,19730,12562,12562,12562,12562,19730,12562,12562,19730,19730,12562,12562,19730,
};

const uint16_t backgroundNight[]=
{
	33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,33601,33601,33601,33601,33601,33601,33601,33601,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,33601,33601,33601,33601,33601,33601,33601,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,33601,33601,33601,33601,33601,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,33601,33601,33601,33601,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,33601,33601,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,33601,33601,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,8729,8729,8729,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,8729,8729,8729,8729,16672,16672,16672,16672,16672,8729,8729,8729,8729,8729,8729,8729,16672,16672,16672,16672,16672,16672,16672,8729,8729,16672,16672,16672,16672,16672,16672,8729,8729,8729,8729,8729,8729,16672,16672,16672,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,16672,16672,8729,8729,8729,8729,8729,8729,16672,16672,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,273,273,273,273,33554,33554,33554,273,33554,33554,33554,273,273,273,273,273,33554,33554,273,273,33554,273,33554,33554,273,273,33554,33554,273,33554,33554,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,42761,42761,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,42761,42761,42761,42761,42761,42761,273,273,42761,42761,42761,42761,273,273,42761,42761,42761,273,273,273,42761,42761,42761,42761,273,42761,42761,273,273,42761,42761,273,42761,42761,43273,43273,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,43273,43273,43273,43273,43273,43273,42761,42761,43273,43273,43273,43273,42761,42761,43273,43273,43273,42761,42761,42761,43273,43273,43273,43273,42761,43273,43273,42761,42761,43273,43273,42761,
};

const uint16_t cursor[]=
{
	0,0,65535,0,0,0,0,0,0,0,0,0,65535,65535,0,0,0,0,0,0,0,0,65535,65535,65535,65535,0,0,0,0,0,65535,65535,0,65535,65535,65535,65535,0,0,65535,65535,0,65535,0,0,65535,65535,65535,65535,0,65535,65535,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,0,0,65535,65535,0,0,0,0,0,0,0,0,65535,0,0,0,0,0,0,0,
};

const uint16_t corner[]=
{
	5536,5536,5536,5536,0,0,0,20083,0,0,20083,20083,5536,5536,5536,0,0,20083,20083,0,20083,20083,0,0,5536,5536,0,0,0,0,0,20083,20083,0,20083,20083,5536,0,0,20083,20083,0,20083,20083,0,20083,20083,0,0,0,0,20083,0,20083,0,0,20083,20083,0,0,0,20083,0,0,20083,0,0,0,0,0,0,0,0,20083,0,20083,0,0,0,0,0,0,0,0,20083,0,20083,20083,0,0,0,0,0,0,0,0,0,20083,20083,0,20083,0,0,0,0,0,0,0,0,20083,0,20083,20083,0,0,0,0,0,0,0,20083,0,20083,20083,0,0,0,0,0,0,0,0,20083,0,20083,0,0,0,0,0,0,0,0,0,
};

const char *menuText[] = {"Play", "Difficulty", "Options", "Stats"};
const char *optionsText[] = {"Game over text", "Night Theme", "Sound", "Flapping anim", "Go Back"};
const char *difficultyText[] = {"Easy", "Medium", "Hard", "Go Back"};
const char *statsText[] = {"High Score", "Total Score", "Score", "Amt Crashed", "Go Back"};
const char *crashText[] = {"Continue", "Back"};

uint16_t skyColour = 2510;
uint16_t soilColour = 12562;


int main()
{
	initClock();
	initSysTick();
	setupIO();
	initSerial();
	initImages();
	
	initBackground();
	initFlags();

	while (1){
		if(anyButtonPressed()){
			break;
		}
	}

	initMenu();
	initDifficulty();

	delay(500);

	while (1){
		initDayNight();
		initBackground();
		drawMenu(0);
		menuInterface();
	}

	return 0;
}


void initImages(){
	images.pipeIMG = pipeEnd;
	images.backgroundIMG = background;
	images.pipeStartIMG = pipeStart;
	images.birdIMG = birdUp;
}

void initFlags(){
	flags.gameOverText = 1;
	flags.dayNight = 0;
	flags.soundOnOff = 1;
	flags.flappingAnim = 1;
	flags.runOnce = 0;
}

// Function for initializing menu settings
void initMenu(){
	// 0 - Initial menu
	menu[MENUINDEX].menuSelection = 0;
	menu[MENUINDEX].oldSelection = 0;
	menu[MENUINDEX].menuX = 10;
	menu[MENUINDEX].menuY = 50;
	menu[MENUINDEX].menuWidth = 108;
	menu[MENUINDEX].menuHeight = 100;
	menu[MENUINDEX].baseX = menu[MENUINDEX].menuX + cornerSIZE;
	menu[MENUINDEX].baseY = menu[MENUINDEX].menuY + cornerSIZE;
	menu[MENUINDEX].cursorGap = 5;
	menu[MENUINDEX].textHeight = 7;
	menu[MENUINDEX].textGap = 4;
	menu[MENUINDEX].textIncrement = menu[MENUINDEX].textHeight + menu[MENUINDEX].textGap; // 11
	menu[MENUINDEX].textUsed = menuText;
	menu[MENUINDEX].sizeOfText = sizeof(menuText)/sizeof(menuText[0]);

	// 1 - Difficulty Menu
	menu[DIFFINDEX].menuSelection = 0;
	menu[DIFFINDEX].oldSelection = 0;
	menu[DIFFINDEX].menuX = 10;
	menu[DIFFINDEX].menuY = 50;
	menu[DIFFINDEX].menuWidth = 108;
	menu[DIFFINDEX].menuHeight = 100;
	menu[DIFFINDEX].baseX = menu[MENUINDEX].menuX + cornerSIZE;
	menu[DIFFINDEX].baseY = menu[MENUINDEX].menuY + cornerSIZE;
	menu[DIFFINDEX].cursorGap = 5;
	menu[DIFFINDEX].textHeight = 7;
	menu[DIFFINDEX].textGap = 4;
	menu[DIFFINDEX].textIncrement = menu[MENUINDEX].textHeight + menu[MENUINDEX].textGap; // 11
	menu[DIFFINDEX].textUsed = difficultyText;
	menu[DIFFINDEX].sizeOfText = sizeof(difficultyText)/sizeof(difficultyText[0]);

	// 2- Options
	menu[OPTIONINDEX].menuSelection = 0;
	menu[OPTIONINDEX].oldSelection = 0;
	menu[OPTIONINDEX].menuX = 0;
	menu[OPTIONINDEX].menuY = 0;
	menu[OPTIONINDEX].menuWidth = MAXSCREENX;
	menu[OPTIONINDEX].menuHeight = MAXSCREENY;
	menu[OPTIONINDEX].baseX = menu[OPTIONINDEX].menuX + cornerSIZE;
	menu[OPTIONINDEX].baseY = menu[OPTIONINDEX].menuY + cornerSIZE;
	menu[OPTIONINDEX].cursorGap = 5;
	menu[OPTIONINDEX].textHeight = 7;
	menu[OPTIONINDEX].textGap = 4;
	menu[OPTIONINDEX].textIncrement = menu[OPTIONINDEX].textHeight + menu[OPTIONINDEX].textGap;
	menu[OPTIONINDEX].textUsed = optionsText;
	menu[OPTIONINDEX].sizeOfText = sizeof(optionsText)/sizeof(optionsText[0]);

	// 3 - Stats
	menu[STATSINDEX].menuSelection = 0;
	menu[STATSINDEX].oldSelection = 0;
	menu[STATSINDEX].menuX = 0;
	menu[STATSINDEX].menuY = 0;
	menu[STATSINDEX].menuWidth = MAXSCREENX;
	menu[STATSINDEX].menuHeight = MAXSCREENY;
	menu[STATSINDEX].baseX = menu[STATSINDEX].menuX + cornerSIZE;
	menu[STATSINDEX].baseY = menu[STATSINDEX].menuY + cornerSIZE;
	menu[STATSINDEX].cursorGap = 5;
	menu[STATSINDEX].textHeight = 7;
	menu[STATSINDEX].textGap = 24;
	menu[STATSINDEX].textIncrement = menu[STATSINDEX].textHeight + menu[STATSINDEX].textGap;
	menu[STATSINDEX].textUsed = statsText;
	menu[STATSINDEX].sizeOfText = sizeof(statsText)/sizeof(statsText[0]);

	// 4 - Crash Menu
	menu[CRASHINDEX].menuSelection = 0;
	menu[CRASHINDEX].oldSelection = 0;
	menu[CRASHINDEX].menuX = 30;
	menu[CRASHINDEX].menuY = 50;
	menu[CRASHINDEX].menuWidth = 68;
	menu[CRASHINDEX].menuHeight = 50;
	menu[CRASHINDEX].baseX = menu[CRASHINDEX].menuX + cornerSIZE;
	menu[CRASHINDEX].baseY = menu[CRASHINDEX].menuY + cornerSIZE;
	menu[CRASHINDEX].cursorGap = 5;
	menu[CRASHINDEX].textHeight = 7;
	menu[CRASHINDEX].textGap = 4;
	menu[CRASHINDEX].textIncrement = menu[MENUINDEX].textHeight + menu[MENUINDEX].textGap; // 11
	menu[CRASHINDEX].textUsed = crashText;
	menu[CRASHINDEX].sizeOfText = sizeof(crashText)/sizeof(crashText[0]);
}


int getFlagColour(int currMenu, int currSelection){

	if (currMenu == DIFFINDEX && (menu[currMenu].oldSelection < menu[currMenu].sizeOfText)){

		switch (currSelection){
			case 0: return GREEN;
			case 1: return ORANGE;
			case 2: return RED;
			default: return WHITE;
		}

		
	}
	else if (currMenu == OPTIONINDEX && (menu[currMenu].oldSelection < menu[currMenu].sizeOfText)){

		// if (currSelection != difficulty.active) return WHITE;
		switch (currSelection){
			case 0: return flags.gameOverText ? GREEN : RED;
			case 1: return flags.dayNight ? GREEN : RED;
			case 2: return flags.soundOnOff ? GREEN : RED;
			case 3: return flags.flappingAnim ? GREEN : RED;
			default: return WHITE;
		}
		
	}
	else if (currMenu == STATSINDEX && (menu[currMenu].oldSelection < menu[currMenu].sizeOfText)){
		switch (currSelection){
			case 0: return ORANGE;
			case 1: return GREEN;
			case 2: return BLUE;
			case 3: return RED;
			default: return WHITE;
		}
	}

	return WHITE;
}


// Function for drawing the menu sprites & text
void drawMenu(uint8_t i){

	uint16_t colour = WHITE;

	// Create menu block
	fillRectangle(menu[i].menuX, menu[i].menuY, menu[i].menuWidth, menu[i].menuHeight, 0); // menu size of colour 0 (black)
	fillRectangle(menu[i].menuX+2, menu[i].menuY+2, menu[i].menuWidth-4, menu[i].menuHeight-4, 20083); // fill inside of menu size with gray
	fillRectangle(menu[i].menuX+3, menu[i].menuY+3, menu[i].menuWidth-6, menu[i].menuHeight-6, 0); // fill insize of gray with black, this makes the gray look like a border

	// Put corner image in each corner
	putImageV2(menu[i].menuX, menu[i].menuY, cornerSIZE, cornerSIZE, corner, 0, 0); // top left corner
    putImageV2(menu[i].menuX + menu[i].menuWidth - cornerSIZE, menu[i].menuY, cornerSIZE, cornerSIZE, corner, 1, 0);// top right corner
    putImageV2(menu[i].menuX, menu[i].menuY + menu[i].menuHeight - cornerSIZE, cornerSIZE, cornerSIZE, corner, 0, 1); // bottom left corner
    putImageV2(menu[i].menuX + menu[i].menuWidth - cornerSIZE, menu[i].menuY + menu[i].menuHeight - cornerSIZE, cornerSIZE, cornerSIZE, corner, 1, 1); // bottom right corner

	// Draw each string from menuText array 
	for (int j = 0; j<menu[i].sizeOfText; j++){
		colour = getFlagColour(i, j);
		printText(menu[i].textUsed[j], menu[i].baseX, menu[i].baseY + (menu[i].textIncrement * j), colour, 0); // baseY+(textIncrement*i)
	}
}

// For navigation around the menu
void menuNavigation(uint8_t i){

	if (menu[i].changeMenu){
		uint16_t oldY = menu[i].baseY + menu[i].textIncrement * menu[i].oldSelection;
		uint16_t newY = menu[i].baseY + menu[i].textIncrement * menu[i].menuSelection;
		uint16_t textWidth = menu[i].menuWidth - 3 - cornerSIZE;

		uint16_t colour = 65535;
		uint16_t backColour = 0; // grey = 54172

		// Pick colour for each option
		colour = getFlagColour(i, menu[i].oldSelection);

		if (i == 1){
			if (menu[i].oldSelection == difficulty.active){
				backColour = 65535;
			}
		}

		// Draw over the old selection & redraw text
		fillRectangle(menu[i].baseX - menu[i].cursorGap, oldY-1, textWidth, menu[i].textHeight+2, 0);
		printText(menu[i].textUsed[menu[i].oldSelection], menu[i].baseX, oldY, colour, backColour);

		// Keep track of the old selection for the next time the code block runs
		menu[i].oldSelection = menu[i].menuSelection; 

		backColour = 0;

		if (i == 1){
			if (menu[i].menuSelection == difficulty.active){
				backColour = 65535;
			}
		}

		// Get new colour for each option
		colour = getFlagColour(i, menu[i].oldSelection);

		// Draw over new selection, draw cursor then draw new text with shifted x position
		fillRectangle(menu[i].baseX, newY, textWidth, menu[i].textHeight, 0);
		putImage(menu[i].baseX - menu[i].cursorGap, newY-1, cursorWidth, cursorHeight, cursor, 0, 0);
		printText(menu[i].textUsed[menu[i].menuSelection], menu[i].baseX + cursorWidth + 2, newY, colour, backColour);

		menu[i].changeMenu = 0;
	}


	if (upPressed()){
		if (menu[i].menuSelection <= 0) menu[i].menuSelection = menu[i].sizeOfText - 1; // If out of bounds, reset to max size
		else menu[i].menuSelection--;
		menu[i].changeMenu = 1;
		delay(200);
	}
	if (downPressed()){
		if (menu[i].menuSelection < menu[i].sizeOfText - 1) menu[i].menuSelection++; // If out of bounds, reset to min size
		else menu[i].menuSelection = 0;
		menu[i].changeMenu = 1;
		delay(200);
	}	
}

void drawStats(uint8_t i){
	uint16_t newY = menu[i].baseY + menu[i].textHeight + 4;
	uint16_t newX = menu[i].baseX + cursorWidth + 2;
	printNumber(stats.highScore, newX , newY + (menu[i].textIncrement * 0), getFlagColour(i, 0), 0);
	printNumber(stats.totScore, newX, newY + (menu[i].textIncrement * 1), getFlagColour(i, 1), 0);
	printNumber(stats.oldScore, newX, newY + (menu[i].textIncrement * 2), getFlagColour(i, 2), 0);
	printNumber(stats.amtCrashed, newX, newY + (menu[i].textIncrement * 3), getFlagColour(i, 3), 0);
}

void statsMenu(){
	menu[STATSINDEX].changeMenu = 1; // Force the arrow to get drawn
	drawStats(STATSINDEX);
	while (1){

		menuNavigation(STATSINDEX);

		if (enterPressedOnce() || rightPressed() || leftPressed()){
			switch (menu[STATSINDEX].menuSelection){
				case 0: // High Score
					stats.highScore = 0;
					continue;
				case 1: // Total Score
					stats.totScore = 0;
					continue;
				case 2: // Score
					stats.oldScore = 0;
					continue;
				case 3: // Amount Crashed
					stats.amtCrashed = 0;
					continue;;
				case 4: // Go Back
					delay(200);
					return;
				default:
					break;
			}
			drawStats(STATSINDEX);
			delay(200);
			continue;
		}

		delay(50);
	}
}

void crashMenu(){
	menu[STATSINDEX].changeMenu = 1; // Force the arrow to get drawn
	drawStats(STATSINDEX);
	while (1){

		menuNavigation(STATSINDEX);

		if (enterPressedOnce() || rightPressed() || leftPressed()){
			switch (menu[STATSINDEX].menuSelection){
				case 0: // High Score
					stats.highScore = 0;
					continue;
				case 1: // Total Score
					stats.totScore = 0;
					continue;
				case 2: // Score
					stats.oldScore = 0;
					continue;
				case 3: // Amount Crashed
					stats.amtCrashed = 0;
					continue;;
				case 4: // Go Back
					delay(200);
					return;
				default:
					break;
			}
			drawStats(STATSINDEX);
			delay(200);
			continue;
		}

		delay(50);
	}
}

// Function for redrawing a selected text with a different colour, i.e. turn off sound, sound colour green -> red; redraw sound text
void updateOption(int currMenu, int selection){
	uint16_t colour = getFlagColour(currMenu, selection);
	
	printText(menu[currMenu].textUsed[selection], menu[currMenu].baseX + cursorWidth + 2, menu[currMenu].baseY + menu[currMenu].textIncrement * selection, colour, 0);
}

void updateDiff(int currMenu, int selection){
	uint16_t colour = getFlagColour(currMenu, selection);
	
	printText(menu[currMenu].textUsed[selection], menu[currMenu].baseX, menu[currMenu].baseY + menu[currMenu].textIncrement * selection, colour, 0);
}

void difficultyMenu(){
	menu[DIFFINDEX].changeMenu = 1;
	menu[DIFFINDEX].menuSelection = difficulty.active;
	
	while(1){
		menuNavigation(DIFFINDEX);

		if (enterPressedOnce() || rightPressed() || leftPressed()){
			switch (menu[DIFFINDEX].menuSelection){
				case 0: // Easy
					difficulty.oldActive = difficulty.active;
					difficulty.active = 0;
					updateOption(DIFFINDEX, difficulty.active);
					updateDiff(DIFFINDEX, difficulty.oldActive);

					menu[DIFFINDEX].changeMenu = 1;

					delay(200);
					continue;
				case 1: // Medium
					difficulty.oldActive = difficulty.active;
					difficulty.active = 1;
					updateOption(DIFFINDEX, difficulty.active);
					updateDiff(DIFFINDEX, difficulty.oldActive);

					menu[DIFFINDEX].changeMenu = 1;

					delay(200);
					continue;
				case 2: // Hard
					difficulty.oldActive = difficulty.active;
					difficulty.active = 2;
					updateOption(DIFFINDEX, difficulty.active);
					updateDiff(DIFFINDEX, difficulty.oldActive);

					menu[DIFFINDEX].changeMenu = 1;

					delay(200);
					continue;
				case 3: // Go back
					return;
				default:
					break;
			}
		}

		delay(50);
	}
}

void optionsMenu(){
	menu[OPTIONINDEX].changeMenu = 1; // Force the arrow to get drawn
	while (1){

		menuNavigation(OPTIONINDEX);

		if (enterPressedOnce() || rightPressed() || leftPressed()){
			switch (menu[OPTIONINDEX].menuSelection){
				case 0: // Game over text
					flags.gameOverText ^= 1;
					updateOption(OPTIONINDEX, 0);
					delay(200);
					continue;
				case 1: // Day Night
					flags.dayNight ^= 1;
					updateOption(OPTIONINDEX, 1);
					delay(200);
					continue;
				case 2: // Sound
					// drawMenu(2);
					// menuNavigation(2);
					continue;
				case 3: // Flapping anim
					flags.flappingAnim ^= 1;
					images.birdIMG = birdUp;
					updateOption(OPTIONINDEX, 3);
					delay(200);
					continue;;
				case 4: // Go back
					return;
				default:
					break;
			}
		}

		delay(50);
	}
}




// Function for the main menu 
void menuInterface(){
	menu[MENUINDEX].changeMenu = 1;
	while (1){

		menuNavigation(MENUINDEX);

		if (enterPressed()){
			switch (menu[MENUINDEX].menuSelection){
				case 0: // play
					initBackground();
					gameLoop();
					return;
				case 1: // Difficulty
					/*Clear current text
					Call menuInterface and pass number 1, which indicates difficulty menu
					instead of menu[MENUINDEX] I have menu[i], 
					*/
					drawMenu(1);
					difficultyMenu();
					delay(100);
					return;
				case 2: // Options
					drawMenu(2);
					optionsMenu();
					delay(100);
					return;
				case 3: // Info
					drawMenu(3);
					statsMenu();
					return;
				
				default:
					break;
			}
		}

		delay(50);
	}
}

void initDayNight(){
	if (flags.dayNight){
		images.pipeIMG = pipeEndNight;
		images.backgroundIMG = backgroundNight;
		images.pipeStartIMG = pipeStartNight;
		skyColour = 33336;
		soilColour = 43273;
	}
	else{
		images.pipeIMG = pipeEnd;
		images.backgroundIMG = background;
		images.pipeStartIMG = pipeStart;
		skyColour = 2510;
		soilColour = 12562;
	}
}

// Scrolling text for when bird crashes
void gameOverText(struct pipe *pipes){

	if (!flags.gameOverText){
		return;
	}

	int i;
	for (i = 0; i<difficulty.pipesAmt; i++){
		pipes[i].speed = 0; // Stop pipes from moving
	}

	int x = 12;
	int y = 40;
	int widthOfText = 106;
	int speedOfText = 2;
	int finalY = 24;

	int oldy = y;
	for (i = y; i > finalY; i-= speedOfText){
		fillBackground(x, oldy+14-speedOfText, widthOfText, 14);
		oldy = i;

		putImageV2(bird.x, bird.y, BIRDWIDTH, BIRDHEIGHT, images.birdIMG, 0, 0);
		drawPipe(pipes);
		printNumber(stats.oldScore, 10, 10, 65535, 0);
		addBoundingBox(10, 10, 0, 2, 1);

		// serves as a speed up option, rather than waiting for text to stop scrolling, press enter to get back into game
		if (enterPressedOnce()){
			fillBackground(x, i, widthOfText, 14);
			putImageV2(bird.x, bird.y, BIRDWIDTH, BIRDHEIGHT, images.birdIMG, 0, 0);
			drawPipe(pipes);
			printNumber(stats.oldScore, 10, 10, 65535, 0);
			addBoundingBox(10, 10, 0, 2, 1);
			printTextX2("Game Over", x, finalY, 5920, 0, 0);
			delay(100);
			return;
		}

		printTextX2("Game Over", x, i, 5920, 0, 0);
		delay(150);
	}
	// need to re-render everything once more after for loop
	fillBackground(x, oldy+14-speedOfText, widthOfText, 14);
	putImageV2(bird.x, bird.y, BIRDWIDTH, BIRDHEIGHT, images.birdIMG, 0, 0);
	drawPipe(pipes);
	printNumber(stats.oldScore, 10, 10, 65535, 0);
	addBoundingBox(10, 10, 0, 2, 1);
	printTextX2("Game Over", x, i, 5920, 0, 0);
}

int birdLogic(struct pipe *pipes){

	if(enterPressedOnce()){
		bird.birdVelocity = bird.jumpStrength;
	}

	bird.birdVelocity = bird.birdVelocity + bird.gravity;

	bird.y = bird.y - bird.birdVelocity;

	if (flags.flappingAnim){
		if (bird.birdVelocity < -1) images.birdIMG = birdDown;
		else if (bird.birdVelocity >= -1.5 && bird.birdVelocity < 0) images.birdIMG = birdMid;
		else images.birdIMG = birdUp;
	}

	if (checkCollision(pipes)){
		// Gets re-rendered in the gameOver function, but if gameOver flag is off, no need to remove bird off screen
		if (flags.gameOverText) fillBackground(bird.oldx,bird.oldy,BIRDWIDTH,BIRDHEIGHT);
		flags.gameState = 1;
		return 1;
	}

	if ((bird.y <= MAXSCREENY-BIRDHEIGHT-1) && (bird.y >= 1)){
		fillBackground(bird.oldx,bird.oldy,BIRDWIDTH,BIRDHEIGHT); // x, y, width, height
		bird.oldx = bird.x;
		bird.oldy = bird.y;	

		putImageV2(bird.x, bird.y, BIRDWIDTH, BIRDHEIGHT, images.birdIMG, 0, 0);
		
	}
	else{
		flags.gameState = 1;
	}

	return 0;
}

void drawCrashedBird(){
	if (bird.y >= MAXSCREENY - BIRDHEIGHT){
		delay(50);
		fillBackground(bird.oldx, bird.oldy, BIRDWIDTH, BIRDHEIGHT); // x, y, width, height, colour
		putImageV2(bird.x, MAXSCREENY - BIRDHEIGHT, BIRDWIDTH, BIRDHEIGHT, images.birdIMG, 0, 0);
	}
	else if (bird.y <= MINSCREENY){
		delay(50);
		fillBackground(bird.oldx, bird.oldy, BIRDWIDTH, BIRDHEIGHT); // x, y, width, height, colour
		putImageV2(bird.x, 0, BIRDWIDTH, BIRDHEIGHT, images.birdIMG, 0, 0);
	}
}

void restartGame(struct pipe *pipes){
	initBackground();
	delay(50);
	initPipe(pipes);
	initBird();

	flags.gameState = 0;
}

void updateStats(){
	if (stats.highScore < stats.score) stats.highScore = stats.score;
	stats.amtCrashed += 1;
	stats.totScore += stats.score;
	stats.oldScore = stats.score;
	stats.score = 0;
}

int statsMenu(struct pipes *pipes){
	menu[CRASHINDEX].changeMenu = 1; // Force the arrow to get drawn
	while (1){

		menuNavigation(CRASHINDEX);

		if (enterPressedOnce() || rightPressed() || leftPressed()){
			switch (menu[CRASHINDEX].menuSelection){
				case 0: // Continue
					restartGame(pipes);
					flags.runOnce = 0;
					delay(200);
					return 1;
				case 1: // Back
					restartGame(pipes);
					flags.runOnce = 0;
					delay(200);
					return 0;
				default:
					break;
			}
		}

		delay(50);
	}
}

// Main game loop
void gameLoop(){
	struct pipe pipes[difficulty.pipesAmt];
	initPipe(pipes);
	initBird();
	
	while(1)
	{
		while(flags.gameState){
			if (!flags.runOnce){
				gameOverText(pipes);
				flags.runOnce = 1;
			}

			if (statsMenu(pipes))
		}


		if(!flags.gameState){
			drawPipe(pipes);
			endOfPipeCheck(pipes);
			activatePipes(pipes);

			printNumber(stats.score, 10, 10, 65535, 0);
			addBoundingBox(10, 10, 0, 2, 1);

			if (birdLogic(pipes)){
				updateStats();
				continue;
			}

		}
		else{
			drawCrashedBird();
		}
		
		delay(50);
	}
}

// Initialize map difficulty
void initDifficulty(){
	difficulty.pipesAmt = 3;
	difficulty.start = 60;
	difficulty.end = 100;
	difficulty.spawnGap = 42;
	difficulty.gap = 40 /2; // the gap between top and bottom pipe
	difficulty.active = 0;
	difficulty.oldActive = 0;
}

/* Background is a seemless image of width MAXSCREENX / 4.
Render 4 parts as there isn't enough space in rom to store full image,
then render the sky & soil */
void initBackground(){
	for (uint8_t i = 0; i < bWidth*4; i += bWidth){
		putImageV2(i, bStart, bWidth, bHeight, images.backgroundIMG, 0, 0);
	}
	
	fillRectangle(0, 0, MAXSCREENX, bStart, skyColour); // render sky
	fillRectangle(0, bStart + bHeight, MAXSCREENX, MAXSCREENY - (bStart + bHeight), soilColour); // render soil
}

// Function for drawing topPipe
void drawTopPipe(struct pipe *pipes, uint8_t i){

	// only fill the last 3 pixels rather than the whole image
	fillBackground(pipes[i].oldx + PIPEWIDTH - FILLSTART, MINSCREENY, FILLEND, pipes[i].oldy - difficulty.gap + PIPEHEIGHT);

	pipes[i].oldx = pipes[i].x;
	pipes[i].oldy = pipes[i].y;
	pipes[i].x -= pipes[i].speed;

	putImageV2(pipes[i].x, pipes[i].y - difficulty.gap, PIPEWIDTH, PIPEHEIGHT, images.pipeStartIMG, 0, 0);
	
	uint8_t start = pipes[i].y - difficulty.gap;

	putPipe(pipes[i].x, MINSCREENX, PIPEWIDTH, start, images.pipeIMG);
}

// Function for drawing bottomPipe
void drawBottomPipe(struct pipe *pipes, uint8_t i){
	fillBackground(pipes[i].oldx + PIPEWIDTH - FILLSTART, pipes[i].oldy + difficulty.gap, FILLEND, MAXSCREENY - (pipes[i].oldy + difficulty.gap));

	pipes[i].oldx = pipes[i].x;
	pipes[i].oldy = pipes[i].y;
	pipes[i].x -= pipes[i].speed;
	putImageV2(pipes[i].x, pipes[i].y + difficulty.gap, PIPEWIDTH, PIPEHEIGHT, images.pipeStartIMG, 0, 0);
	
	uint8_t start = pipes[i].y + PIPEHEIGHT + difficulty.gap;

	putPipe(pipes[i].x, start, PIPEWIDTH, MAXSCREENY - start, images.pipeIMG);
}

// Function for drawing the top & bottom pipes
void drawPipe(struct pipe *pipes){
	for (uint8_t i = 0; i < difficulty.pipesAmt; i++){
		if (pipes[i].active){
			drawBottomPipe(pipes, i);
			drawTopPipe(pipes, i);
		}
	}
}

// Function for removing the pipe once the pipe is at the end of the screen
void endOfPipeCheck(struct pipe *pipes){
	for (int i = 0; i < difficulty.pipesAmt; i++){
		if (pipes[i].active){
			if (pipes[i].x < 1){
				pipes[i].x = MAXSCREENX - PIPEWIDTH;
				fillBackground(MINSCREENX, MINSCREENY, PIPEWIDTH+1, MAXSCREENY);
				pipes[i].active = 0;
			}
		}
	}
}

// Initialize pipe settings
void initPipe(struct pipe *pipes){

	for (int i = 0; i < difficulty.pipesAmt; i++){
		pipes[i].speed = 1.5;
		pipes[i].start = 80; // MAX: MAXSCREENY - GAP || MIN: MINSCREENY + GAP + pipeHeight
		pipes[i].x = MAXSCREENX - PIPEWIDTH;
		pipes[i].y = MAXSCREENY - pipes[0].start;
		pipes[i].oldx = pipes[0].x;
		pipes[i].oldy = pipes[0].y;
		pipes[i].active = 0;
	}

	pipes[0].active = 1;
}

// Initializer bird settings
void initBird(){

	bird.x = 35;
	bird.y = 50;

	bird.oldx = bird.x;
	bird.oldy = bird.y;
	
	bird.jumpStrength = 4;
	bird.gravity = -0.75;
	bird.birdVelocity = 0.0;
}

void activatePipes(struct pipe *pipes){
	for (int i = 0; i < difficulty.pipesAmt; i++) {
		int currPipe = (i + 1) % difficulty.pipesAmt;
		if (pipes[i].active && pipes[currPipe].active == 0 && pipes[i].x <= (MAXSCREENX - difficulty.spawnGap - PIPEWIDTH)) {
			pipes[currPipe].active = 1;
			pipes[currPipe].y = randomNum(difficulty.start, difficulty.end); // random y start position for each pipe after pipe#1
		}
	}
}

// Function for checking if points ax1, ax2, ay1, ay2 overlap with bx1, bx2, by1, by2
uint8_t rectsOverlap(uint16_t ax1, uint16_t ax2, uint16_t ay1, uint16_t ay2,
                  uint16_t bx1, uint16_t bx2, uint16_t by1, uint16_t by2)
{
    if (ax2 <= bx1) return 0;
    if (bx2 <= ax1) return 0;

    if (ay2 <= by1) return 0;
    if (by2 <= ay1) return 0;

    return 1;
}

// Function for checking if the bird colides with either pipe
uint8_t checkCollision(struct pipe *pipes){

	uint8_t i = stats.score % difficulty.pipesAmt; // next pipe number

	int birdX1 = bird.x; // left x cords
	int birdY1 = bird.y; // top y cords

	int birdX2 = bird.x + BIRDWIDTH - 1; // right x cords
	int birdY2 = bird.y + BIRDHEIGHT - 1; // bottom y cords

	int pipeX1 = pipes[i].x; // left x cords of pipes
	int pipeY1 = pipes[i].y - difficulty.gap + PIPEHEIGHT - 1; // bottom y cords of top pipe

	int pipeX2 = pipes[i].x + PIPEWIDTH - 1; // right x cords of pipes
	int pipeY2 = pipes[i].y + difficulty.gap; // top y cords of bottom pipe


	if (birdX1 > pipeX2) stats.score += 1; // once bird passes pipe, increase counter & check collision for next pipe

	if (rectsOverlap(birdX1, birdX2, birdY1, birdY2, pipeX1, pipeX2, MINSCREENX, pipeY1)) return 1;

	if (rectsOverlap(birdX1, birdX2, birdY1, birdY2, pipeX1, pipeX2, pipeY2, MAXSCREENY)) return 1;

	return 0;

}

// Function for drawing the pipes onto the screen
void putPipe(uint16_t x, uint16_t y, uint16_t width, uint16_t height, const uint16_t *Image){
	/*
	Rather than using a for loop in the drawBottomPipe/drawTopPipe we draw it using this function
	Reasoning behind this is that using openApertue and transferSPI16 repeatedly causes performance issue
	The main difference between this function and putImageV2 is that index of the image is found using modulo
	*/
	uint16_t Colour;
    uint16_t baseX = x;
    uint16_t baseY = y;

    openAperture(x, y, x + width - 1, y + height - 1); // open the dimensions of the image for writing
    DCHigh();

	for (y = 0; y < height; y++)
        {
            for (x = 0; x < width; x++)
            {
                Colour = Image[x % PIPEWIDTH]; // rather than making one big const array, use a small one and just use modulo

                if (Colour == 5536) { // 5536 = word value of the background pixel within any of the image arrays 
                    Colour = getBackgroundPixel(baseX + x, baseY + y); // get background pixel if the current pixel is a background pixel
                }

                transferSPI16(Colour);
            }
        }
}

// New version of putImage which replaces pixels (of colour 5536) to the background pixel
void putImageV2(uint16_t x, uint16_t y, uint16_t width, uint16_t height, const uint16_t *Image, uint8_t hOrientation, uint8_t vOrientation)
{
    uint16_t Colour;
	uint32_t offset = 0;
	uint16_t baseX = x;
    uint16_t baseY = y;
    openAperture(x, y, x + width - 1, y + height - 1); // open the dimensions of the image for writing
    DCHigh();
	if (hOrientation == 0)
	{
		if (vOrientation == 0)
		{
			for (y = 0; y < height; y++)
			{
				offset=y*width;
				for (x = 0; x < width; x++)
				{
					Colour = Image[offset+x];

					if (Colour == 5536) { // 5536 = word value of the background pixel within any of the image arrays
						Colour = getBackgroundPixel(baseX + x, baseY + y); // get background pixel if the current pixel is a background pixel
					}

					transferSPI16(Colour);
				}
			}
		}
		else
		{
			for (y = 0; y < height; y++)
			{
				offset=(height-(y+1))*width;
				for (x = 0; x < width; x++)
				{
					Colour = Image[offset+x];

					if (Colour == 5536) {
						Colour = getBackgroundPixel(baseX + x, baseY + y);
					}

					transferSPI16(Colour);
				}
			}
		}
	}
	else
    {
        if (vOrientation == 0)
        {
            for (y = 0; y < height; y++)
            {
                offset = y * width;
                for (x = 0; x < width; x++)
                {
                    Colour = Image[offset + (width - x - 1)];

                    if (Colour == 5536) {
                        Colour = getBackgroundPixel(baseX + x, baseY + y);
                    }

                    transferSPI16(Colour);
                }
            }
        }
        else
        {
            for (y = 0; y < height; y++)
            {
                offset = (height - (y + 1)) * width;
                for (x = 0; x < width; x++)
                {
                    Colour = Image[offset + (width - x - 1)];

                    if (Colour == 5536) {
                        Colour = getBackgroundPixel(baseX + x, baseY + y);
                    }

                    transferSPI16(Colour);
                }
            }
        }
    }
}

// Function for filling an area with the background image
void fillBackground(uint16_t x,uint16_t y,uint16_t width, uint16_t height)
{
	int colour;
	uint16_t baseX = x;
	uint16_t baseY = y;
	openAperture(x, y, x + width - 1, y + height - 1);
	DCHigh();

	for (y = 0; y < height; y++){
		for (x = 0; x < width; x++){

			colour = getBackgroundPixel(baseX + x, baseY + y);

			transferSPI16(colour);
		}
	}
}

// Function for drawing a bounding box around printText() & printTextX2()
void addBoundingBox(uint8_t x, uint16_t y, uint16_t colour, uint8_t thickness, uint8_t sizeOfprintText){
	uint8_t numPixelWidth = 33; // width of printText
	uint8_t numPixelHeight = 7; // height of printText

    uint8_t x1 = x - thickness;
	uint16_t y1 = y - thickness;
	
	uint8_t x2 = x + numPixelWidth;
	uint16_t y2 = y + numPixelHeight;


	fillRectangle(x1, y1, numPixelWidth + thickness*2, thickness, colour); // top
	fillRectangle(x1, y, thickness, numPixelHeight + thickness, colour); // left
	fillRectangle(x2, y, thickness, numPixelHeight + thickness, colour); // right
	fillRectangle(x, y2, numPixelWidth, thickness, colour); // bottom
}

// Returns the pixel colour of the background image based on the given X, Y cords 
uint16_t getBackgroundPixel(uint16_t screenX, uint16_t screenY){
	uint16_t colour = 0;

	if (screenY >= bStart && screenY < (bStart + bHeight)) { // check if x, y are within the background cords
		uint8_t index = screenX % bWidth; // column of the x pixel
		uint16_t backgroundIndex = (screenY - bStart) * bWidth + index; // (index of y * row of y pixel) + column of x pixel

		colour = images.backgroundIMG[backgroundIndex];
	}

	else if (screenY < bStart) colour = skyColour; // if y cords are more than background y, colour = sky 
	else if (screenY >= bStart + bHeight) colour = soilColour; // if y cords are less than background y, colour = soil

	return colour;
}

uint8_t anyButtonPressed(){
	return (downPressed() || upPressed() || leftPressed() || rightPressed() || enterPressed()) ? 1 : 0;
}

uint8_t downPressed(){
	return ((GPIOA->IDR & (1 << 11)) == 0) ? 1 : 0;
}

uint8_t upPressed(){
	return ((GPIOA->IDR & (1 << 8)) == 0) ? 1 : 0;
}

uint8_t rightPressed(){
	return ((GPIOB->IDR & (1 << 4))==0) ? 1 : 0;
}

uint8_t leftPressed(){
	return ((GPIOB->IDR & (1 << 5))==0) ? 1 : 0;
}

uint8_t enterPressed(){
	return ((GPIOA->IDR & (1 << 1))==0) ? 1 : 0;
}

// Function for checking if a button gets pressed only once, avoids button holding
uint8_t enterPressedOnce() {
	static uint8_t prevEnterState = 0; // previous state of the button

    uint8_t currState = ((GPIOA->IDR & (1 << 1)) == 0) ? 1 : 0; // if button gets pressed, 1, else 0
    uint8_t pressed = (currState == 1 && prevEnterState == 0); // if button is pressed and hasn't been pressed before
    prevEnterState = currState;

    return pressed;
}

void initSysTick(void)
{
	SysTick->LOAD = 48000;
	SysTick->CTRL = 7;
	SysTick->VAL = 10;
	__asm(" cpsie i "); // enable interrupts
}

void SysTick_Handler(void)
{
	milliseconds++;
}

void initClock(void)
{
	// This is potentially a dangerous function as it could
	// result in a system with an invalid clock signal - result: a stuck system
	// Set the PLL up
	// First ensure PLL is disabled
	RCC->CR &= ~(1u<<24);
	while( (RCC->CR & (1 <<25))); // wait for PLL ready to be cleared
        
	// Warning here: if system clock is greater than 24MHz then wait-state(s) need to be
	// inserted into Flash memory interface
	FLASH->ACR |= (1 << 0);
	FLASH->ACR &=~((1u << 2) | (1u<<1));

	// Turn on FLASH prefetch buffer
	FLASH->ACR |= (1 << 4);

	// set PLL multiplier to 12 (yielding 48MHz)
	RCC->CFGR &= ~((1u<<21) | (1u<<20) | (1u<<19) | (1u<<18));
	RCC->CFGR |= ((1<<21) | (1<<19) ); 

	// Need to limit ADC clock to below 14MHz so will change ADC prescaler to 4
	RCC->CFGR |= (1<<14);

	// and turn the PLL back on again
	RCC->CR |= (1<<24);        
	// set PLL as system clock source 
	RCC->CFGR |= (1<<1);
}
void delay(volatile uint32_t dly)
{
	uint32_t end_time = dly + milliseconds;
	while(milliseconds != end_time)
		__asm(" wfi "); // sleep
}

// enables the pull-ul resistor for a specifified GPIO pin
void enablePullUp(GPIO_TypeDef *Port, uint32_t BitNumber)
{
	Port->PUPDR = Port->PUPDR &~(3u << BitNumber*2); // clear pull-up resistor bits
	Port->PUPDR = Port->PUPDR | (1u << BitNumber*2); // set pull-up bit
}

// sets the mode of a specific GPIO pin on the microcontroller
void pinMode(GPIO_TypeDef *Port, uint32_t BitNumber, uint32_t Mode)
{
	uint32_t mode_value = Port->MODER; // checks the current value of the MODER register for a specified GPIO port
	Mode = Mode << (2 * BitNumber); // left-shifts Mode value by 2 inorder to prepare mode_value to be inserted into its bit position in MODER
	mode_value = mode_value & ~(3u << (BitNumber * 2)); // clears the bits for configuring the mode of given GPIO pins
	mode_value = mode_value | Mode; // sets the two bits for the given GPIO pin with mode_value
	Port->MODER = mode_value; // write mode_value back into MODER register
}

// congiures the microcontroller's GPIO pins for input mode
void setupIO()
{
	RCC->AHBENR |= (1 << 18) + (1 << 17); // enable Ports A and B
	display_begin();
	pinMode(GPIOA,1,0);
	pinMode(GPIOB,4,0);
	pinMode(GPIOB,5,0);
	pinMode(GPIOA,8,0);
	pinMode(GPIOA,11,0);
	enablePullUp(GPIOA,1);
	enablePullUp(GPIOB,4);
	enablePullUp(GPIOB,5);
	enablePullUp(GPIOA,11);
	enablePullUp(GPIOA,8);
}
