/*
need to add flapping animation:
if birdVelocity is >= 0 birdImage = flappingUp
else: birdImage = Normal

Do the main menu

Do difficulties:
Different speeds
Different gaps
Bigger random on the y position

Fix game loop, it looks like a mess
*/

#include <stm32f031x6.h>
#include "display.h"
#include <stdio.h>
#include "prbs.h"
#include "serial.h"
#include <stdint.h>
#include <stddef.h>
#define BLUE 33020
#define MINSCREENX 0
#define MINSCREENY 0
#define MAXSCREENX 128
#define MAXSCREENY 160
#define PIPEWIDTH 14
#define PIPEHEIGHT 4
#define PIPECHUNKHEIGHT 20
#define PIPEFILLERHEIGHT 1
#define BIRDWIDTH 17
#define BIRDHEIGHT 12
#define bHeight 74
#define bWidth 32
#define bStart 65
#define FILLSTART 2
#define FILLEND 3


struct pipe{
	int x;
	uint16_t y;
	int oldx;
	uint16_t oldy;

	uint16_t speed;
	uint16_t start;
	uint16_t gap;
	
	int active;
};

struct bird{
	uint16_t x;
	int y;

	uint16_t oldx;
	int oldy;

	uint16_t jumpStrength;
	float gravity;
	float birdVelocity;
};

struct difficulty{
	int pipesAmt;
	uint8_t start;
	uint8_t end;
	float spawnGap;
};

void initClock(void);
void initSysTick(void);
void SysTick_Handler(void);
void delay(volatile uint32_t dly);
void setupIO();
void enablePullUp(GPIO_TypeDef *Port, uint32_t BitNumber);
void pinMode(GPIO_TypeDef *Port, uint32_t BitNumber, uint32_t Mode);
volatile uint32_t milliseconds;

uint8_t enterPressed();
uint8_t upPressed();
uint8_t downPressed();
uint8_t leftPressed();
uint8_t rightPressed();
uint8_t anyButtonPressed();

uint8_t enterPressedOnce();

void gameLoop();


void drawTopPipe(struct pipe *pipes, uint8_t i);
void drawBottomPipe(struct pipe *pipes, uint8_t i);
void drawPipe(struct pipe *pipes);
void endOfPipeCheck(struct pipe *pipes);
void initPipe(struct pipe *pipes);
void initBird(void);
void initBackground();
void initDifficulty();
void activatePipes(struct pipe *pipes);
uint8_t checkCollision(struct pipe *pipes, uint16_t *counter);

void fillBackground(uint16_t x,uint16_t y,uint16_t width, uint16_t height);
void putImageV2(uint16_t x, uint16_t y, uint16_t width, uint16_t height, const uint16_t *Image);
void addBoundingBox(uint8_t x, uint16_t y, uint16_t colour, uint8_t thickness);

uint16_t getBackgroundPixel(uint16_t screenX, uint16_t screenY);
void putPipe(uint16_t x, uint16_t y, uint16_t width, uint16_t height, const uint16_t *Image);
uint8_t rectsOverlap(uint16_t ax1, uint16_t ax2, uint16_t ay1, uint16_t ay2, uint16_t bx1, uint16_t bx2, uint16_t by1, uint16_t by2);

uint8_t dayNight = 0;


struct difficulty currDifficulty[1];
struct bird bird[1];


const uint16_t bird1[]=
{
	5536,5536,5536,5536,5536,5536,2625,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,5536,5536,2625,2625,65422,65422,65422,2625,24575,24575,2625,5536,5536,5536,5536,5536,5536,5536,2625,65422,65422,65333,65333,2625,24575,24575,24575,24575,2625,5536,5536,5536,5536,2625,2625,2625,2625,65333,65333,65333,2625,56015,24575,24575,2625,24575,2625,5536,5536,2625,24575,24575,24575,24575,2625,65333,65333,2625,56015,24575,24575,2625,24575,2625,5536,5536,2625,24575,24575,24575,24575,24575,2625,65333,65333,2625,56015,24575,24575,24575,2625,5536,5536,2625,65422,24575,24575,24575,65422,2625,65333,65333,65333,2625,2625,2625,2625,2625,2625,5536,5536,2625,65422,65422,65422,2625,65333,65333,65333,2625,7937,7937,7937,7937,7937,7937,2625,5536,5536,2625,2625,2625,7212,7212,7212,2625,7937,2625,2625,2625,2625,2625,2625,5536,5536,5536,2625,7212,7212,7212,7212,7212,7212,2625,7937,7937,7937,7937,7937,2625,5536,5536,5536,5536,2625,2625,7212,7212,7212,7212,7212,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,2625,2625,2625,2625,2625,5536,5536,5536,5536,5536,5536,5536,
};

const uint16_t pipeStart[]=
{
	2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,56463,56463,7047,22911,30574,21854,12877,4165,3380,27692,18980,35356,2625,2625,56463,56463,7047,22911,30574,21854,12877,4165,3380,27692,18980,35356,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,2625,
};

const uint16_t pipeStartNight[]=
{
	512,512,512,512,512,512,512,512,512,512,512,512,512,512,512,62277,62277,12861,28725,36388,27668,26891,18179,17666,41730,33281,49409,512,512,62277,62277,12861,28725,36388,27668,26891,18179,17666,41730,33281,49409,512,512,512,512,512,512,512,512,512,512,512,512,512,512,512,
};

const uint16_t pipeEnd[]=
{
	5536,2625,13142,55150,14719,39559,39030,46174,45389,60980,43820,10788,2625,5536,
};

const uint16_t pipeEndNight[]=
{
	5536,256,27411,60964,20789,45373,44844,60179,59395,9474,57857,24833,512,5536,
};

const uint16_t background[]=
{
	2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64471,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,2510,2510,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64471,2510,2510,2510,2510,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,64983,64983,64983,64983,64983,64983,64983,64983,64983,64983,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,64983,64983,64983,64983,64983,64983,64983,64983,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,64983,64983,64983,64983,64983,64983,64983,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,64983,64983,64983,64983,64983,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,64983,64983,64983,64983,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,64983,64983,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,64983,64983,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,47295,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,12158,12158,18301,12158,12158,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,12158,12158,18301,18301,12158,12158,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,47295,47295,47295,47295,47295,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,16733,16733,16733,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,18301,16733,16733,16733,16733,18301,18301,18301,18301,18301,16733,16733,16733,16733,16733,16733,16733,18301,18301,18301,18301,18301,18301,18301,16733,16733,18301,18301,18301,18301,18301,18301,16733,16733,16733,16733,16733,16733,18301,18301,18301,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,18301,18301,16733,16733,16733,16733,16733,16733,18301,18301,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,16733,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,43599,26182,26182,26182,26182,43599,43599,43599,26182,43599,43599,43599,26182,26182,26182,26182,26182,43599,43599,26182,26182,43599,26182,43599,43599,26182,26182,43599,43599,26182,43599,43599,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,19730,19730,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,26182,19730,19730,19730,19730,19730,19730,26182,26182,19730,19730,19730,19730,26182,26182,19730,19730,19730,26182,26182,26182,19730,19730,19730,19730,26182,19730,19730,26182,26182,19730,19730,26182,19730,19730,12562,12562,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,19730,12562,12562,12562,12562,12562,12562,19730,19730,12562,12562,12562,12562,19730,19730,12562,12562,12562,19730,19730,19730,12562,12562,12562,12562,19730,12562,12562,19730,19730,12562,12562,19730,
};

const uint16_t backgroundNight[]=
{
	33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33336,33336,33336,33336,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,33601,33601,33601,33601,33601,33601,33601,33601,33601,33601,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,33601,33601,33601,33601,33601,33601,33601,33601,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,33601,33601,33601,33601,33601,33601,33601,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,33601,33601,33601,33601,33601,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,33601,33601,33601,33601,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,33601,33601,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,33601,33601,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,49720,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,12083,12083,16672,12083,12083,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,12083,12083,16672,16672,12083,12083,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,49720,49720,49720,49720,49720,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,8729,8729,8729,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,16672,8729,8729,8729,8729,16672,16672,16672,16672,16672,8729,8729,8729,8729,8729,8729,8729,16672,16672,16672,16672,16672,16672,16672,8729,8729,16672,16672,16672,16672,16672,16672,8729,8729,8729,8729,8729,8729,16672,16672,16672,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,16672,16672,8729,8729,8729,8729,8729,8729,16672,16672,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,8729,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,33554,273,273,273,273,33554,33554,33554,273,33554,33554,33554,273,273,273,273,273,33554,33554,273,273,33554,273,33554,33554,273,273,33554,33554,273,33554,33554,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,42761,42761,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,273,42761,42761,42761,42761,42761,42761,273,273,42761,42761,42761,42761,273,273,42761,42761,42761,273,273,273,42761,42761,42761,42761,273,42761,42761,273,273,42761,42761,273,42761,42761,43273,43273,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,42761,43273,43273,43273,43273,43273,43273,42761,42761,43273,43273,43273,43273,42761,42761,43273,43273,43273,42761,42761,42761,43273,43273,43273,43273,42761,43273,43273,42761,42761,43273,43273,42761,
};

uint16_t skyColour = 2510;
uint16_t soilColour = 12562;

const uint16_t *pipeIMG = pipeEnd;
const uint16_t *backgroundIMG = background;
const uint16_t *pipeStartIMG = pipeStart;

int main()
{
	initClock();
	initSysTick();
	setupIO();
	initSerial();

	dayNight = 1;
	
	if (dayNight){
		pipeIMG = pipeEndNight;
		backgroundIMG = backgroundNight;
		pipeStartIMG = pipeStartNight;
		skyColour = 33336;
		soilColour = 43273;
	}

	initBackground();

	while (1){
		if(anyButtonPressed()){
			break;
		}
	}

	initDifficulty();

	delay(500);
	gameLoop();

	return 0;
}

// Main game loop
void gameLoop(){
	struct pipe pipes[currDifficulty[0].pipesAmt];
	initPipe(pipes);
	initBird();

	uint8_t gameCrashed = 0;
	uint16_t counter = 0;

	
	while(1)
	{
		while(gameCrashed == 1){
			if(leftPressed()){
				initBackground();
				delay(50);
				initPipe(pipes);
				initBird();

				gameCrashed = 0;
				counter = 0;
				break;
			}
		}

		if(enterPressedOnce()){
			bird[0].birdVelocity = bird[0].jumpStrength;
		}

		if(gameCrashed == 0){
			drawPipe(pipes);
			endOfPipeCheck(pipes);
			activatePipes(pipes);

			bird[0].birdVelocity = bird[0].birdVelocity + bird[0].gravity;

			bird[0].y = bird[0].y - bird[0].birdVelocity;

			if (checkCollision(pipes, &counter)){
				gameCrashed = 1;
				continue;
			}

			printNumber(counter, 10, 10, 65535, 0);
			addBoundingBox(10, 10, 0, 2);

			if ((bird[0].y <= MAXSCREENY-BIRDHEIGHT-1) && (bird[0].y >= 1)){
				fillBackground(bird[0].oldx,bird[0].oldy,BIRDWIDTH,BIRDHEIGHT); // x, y, width, height
				bird[0].oldx = bird[0].x;
				bird[0].oldy = bird[0].y;	

				putImageV2(bird[0].x,bird[0].y,BIRDWIDTH,BIRDHEIGHT,bird1);
				
			}
			else{
				gameCrashed = 1;
			}
		}
		else if (bird[0].y >= MAXSCREENY - BIRDHEIGHT){
			delay(50);
			fillBackground(bird[0].oldx,bird[0].oldy,BIRDWIDTH,BIRDHEIGHT); // x, y, width, height, colour
			putImageV2(bird[0].x,MAXSCREENY - BIRDHEIGHT,BIRDWIDTH,BIRDHEIGHT,bird1);
		}
		else if (bird[0].y <= MINSCREENY){
			delay(50);
			fillBackground(bird[0].oldx,bird[0].oldy,BIRDWIDTH,BIRDHEIGHT); // x, y, width, height, colour
			putImageV2(bird[0].x,0,BIRDWIDTH,BIRDHEIGHT,bird1);
		}

		delay(50);
	}
}

// Initialize map difficulty
void initDifficulty(){
	currDifficulty[0].pipesAmt = 3;
	currDifficulty[0].start = 60;
	currDifficulty[0].end = 100;
	currDifficulty[0].spawnGap = 42;
}

/* 
Background is a seemless image of width MAXSCREENX / 4.
Render 4 parts as there isn't enough space in rom to store full image,
then render the sky & soil
*/
void initBackground(){
	for (uint8_t i = 0; i < bWidth*4; i += bWidth){
		putImageV2(i, bStart, bWidth, bHeight, backgroundIMG);
	}
	
	fillRectangle(0, 0, MAXSCREENX, bStart, skyColour); // render sky
	fillRectangle(0, bStart + bHeight, MAXSCREENX, MAXSCREENY - (bStart + bHeight), soilColour); // render soil
}

// Function for drawing topPipe
void drawTopPipe(struct pipe *pipes, uint8_t i){

	// only fill the last 3 pixels rather than the whole image
	fillBackground(pipes[i].oldx + PIPEWIDTH - FILLSTART, MINSCREENY, FILLEND, pipes[i].oldy - pipes[i].gap + PIPEHEIGHT);

	pipes[i].oldx = pipes[i].x;
	pipes[i].oldy = pipes[i].y;
	pipes[i].x -= pipes[i].speed;

	putImageV2(pipes[i].x, pipes[i].y - pipes[i].gap, PIPEWIDTH, PIPEHEIGHT, pipeStartIMG);
	
	uint8_t start = pipes[i].y - pipes[i].gap;

	putPipe(pipes[i].x, MINSCREENX, PIPEWIDTH, start, pipeIMG);
}

// Function for drawing bottomPipe
void drawBottomPipe(struct pipe *pipes, uint8_t i){
	fillBackground(pipes[i].oldx + PIPEWIDTH - FILLSTART, pipes[i].oldy + pipes[i].gap, FILLEND, MAXSCREENY - (pipes[i].oldy + pipes[i].gap));

	pipes[i].oldx = pipes[i].x;
	pipes[i].oldy = pipes[i].y;
	pipes[i].x -= pipes[i].speed;
	putImageV2(pipes[i].x, pipes[i].y + pipes[i].gap, PIPEWIDTH, PIPEHEIGHT, pipeStartIMG);
	
	uint8_t start = pipes[i].y + PIPEHEIGHT + pipes[i].gap;

	putPipe(pipes[i].x, start, PIPEWIDTH, MAXSCREENY - start, pipeIMG);
}

// Function for drawing the top & bottom pipes
void drawPipe(struct pipe *pipes){
	for (uint8_t i = 0; i < currDifficulty[0].pipesAmt; i++){
		if (pipes[i].active){
			drawBottomPipe(pipes, i);
			drawTopPipe(pipes, i);
		}
	}
}

// Function for removing the pipe once the pipe is at the end of the screen
void endOfPipeCheck(struct pipe *pipes){
	for (int i = 0; i < currDifficulty[0].pipesAmt; i++){
		if (pipes[i].active){
			if (pipes[i].x < 1){
				pipes[i].x = MAXSCREENX - PIPEWIDTH;
				fillBackground(MINSCREENX, MINSCREENY, PIPEWIDTH+1, MAXSCREENY);
				pipes[i].active = 0;
			}
		}
	}
}

// Initialize pipe settings
void initPipe(struct pipe *pipes){

	for (int i = 0; i < currDifficulty[0].pipesAmt; i++){
		pipes[i].speed = 1.5;
		pipes[i].start = 80; // MAX: MAXSCREENY - GAP || MIN: MINSCREENY + GAP + pipeHeight
		pipes[i].x = MAXSCREENX - PIPEWIDTH;
		pipes[i].y = MAXSCREENY - pipes[0].start;
		pipes[i].oldx = pipes[0].x;
		pipes[i].oldy = pipes[0].y;
		pipes[i].active = 0;
		pipes[i].gap = 40 / 2; // the gap between top & bottom pipe
	}

	pipes[0].active = 1;
}

// Initializer bird settings
void initBird(){

	bird[0].x = 35;
	bird[0].y = 50;

	bird[0].oldx = bird[0].x;
	bird[0].oldy = bird[0].y;
	
	bird[0].jumpStrength = 4;
	bird[0].gravity = -0.75;
	bird[0].birdVelocity = 0.0;
}

void activatePipes(struct pipe *pipes){
	for (int i = 0; i < currDifficulty[0].pipesAmt; i++) {
		int currPipe = (i + 1) % currDifficulty[0].pipesAmt;
		if (pipes[i].active && pipes[currPipe].active == 0 && pipes[i].x <= (MAXSCREENX - currDifficulty[0].spawnGap - PIPEWIDTH)) {
			pipes[currPipe].active = 1;
			pipes[currPipe].y = randomNum(currDifficulty[0].start, currDifficulty[0].end); // random y start position for each pipe after pipe#1
		}
	}
}

// Function for checking if points ax1, ax2, ay1, ay2 overlap with bx1, bx2, by1, by2
uint8_t rectsOverlap(uint16_t ax1, uint16_t ax2, uint16_t ay1, uint16_t ay2,
                  uint16_t bx1, uint16_t bx2, uint16_t by1, uint16_t by2)
{
    if (ax2 <= bx1) return 0;
    if (bx2 <= ax1) return 0;

    if (ay2 <= by1) return 0;
    if (by2 <= ay1) return 0;

    return 1;
}

// Function for checking if the bird colides with either pipe
uint8_t checkCollision(struct pipe *pipes, uint16_t *counter){

	uint8_t i = *counter % currDifficulty[0].pipesAmt; // next pipe number

	int birdX1 = bird[0].x; // left x cords
	int birdY1 = bird[0].y; // top y cords

	int birdX2 = bird[0].x + BIRDWIDTH; // right x cords
	int birdY2 = bird[0].y + BIRDHEIGHT; // bottom y cords

	int pipeX1 = pipes[i].x; // left x cords of pipes
	int pipeY1 = pipes[i].y - pipes[i].gap + PIPEHEIGHT; // bottom y cords of top pipe

	int pipeX2 = pipes[i].x + PIPEWIDTH; // right x cords of pipes
	int pipeY2 = pipes[i].y + pipes[i].gap; // top y cords of bottom pipe


	if (birdX1 > pipeX2) *counter += 1; // once bird passes pipe, increase counter & check collision for next pipe

	if (rectsOverlap(birdX1, birdX2, birdY1, birdY2, pipeX1, pipeX2, MINSCREENX, pipeY1)) return 1;

	if (rectsOverlap(birdX1, birdX2, birdY1, birdY2, pipeX1, pipeX2, pipeY2, MAXSCREENY)) return 1;

	return 0;

}

// Function for drawing the pipes onto the screen
void putPipe(uint16_t x, uint16_t y, uint16_t width, uint16_t height, const uint16_t *Image){
	/*
	Rather than using a for loop in the drawBottomPipe/drawTopPipe we draw it using this function
	Reasoning behind this is that using openApertue and transferSPI16 repeatedly causes performance issue
	The main difference between this function and putImageV2 is that index of the image is found using modulo
	*/
	uint16_t Colour;
    uint16_t baseX = x;
    uint16_t baseY = y;

    openAperture(x, y, x + width - 1, y + height - 1); // open the dimensions of the image for writing
    DCHigh();

	for (y = 0; y < height; y++)
        {
            for (x = 0; x < width; x++)
            {
                Colour = Image[x % PIPEWIDTH]; // rather than making one big const array, use a small one and just use modulo

                if (Colour == 5536) { // 5536 = word value of the background pixel within any of the image arrays 
                    Colour = getBackgroundPixel(baseX + x, baseY + y); // get background pixel if the current pixel is a background pixel
                }

                transferSPI16(Colour);
            }
        }
}

// New version of putImage which replaces pixels (of colour 5536) to the background pixel
void putImageV2(uint16_t x, uint16_t y, uint16_t width, uint16_t height, const uint16_t *Image)
{
    uint16_t Colour;
    uint32_t offset = 0;
    uint16_t baseX = x;
    uint16_t baseY = y;

    openAperture(x, y, x + width - 1, y + height - 1); // open the dimensions of the image for writing
    DCHigh();


	for (y = 0; y < height; y++)
	{
		offset = y * width;
		for (x = 0; x < width; x++)
		{
			Colour = Image[offset + x];

			if (Colour == 5536) { // 5536 = word value of the background pixel within any of the image arrays 
				Colour = getBackgroundPixel(baseX + x, baseY + y); // get background pixel if the current pixel is a background pixel
			}

			transferSPI16(Colour);
		}
	}
}

// Function for filling an area with the background image
void fillBackground(uint16_t x,uint16_t y,uint16_t width, uint16_t height)
{
	int colour;
	uint16_t baseX = x;
	uint16_t baseY = y;
	openAperture(x, y, x + width - 1, y + height - 1);
	DCHigh();

	for (y = 0; y < height; y++){
		for (x = 0; x < width; x++){

			colour = getBackgroundPixel(baseX + x, baseY + y);

			transferSPI16(colour);
		}
	}
}

// Function for drawing a bounding box around printText()
void addBoundingBox(uint8_t x, uint16_t y, uint16_t colour, uint8_t thickness){
	uint8_t numPixelWidth = 33;
	uint8_t numPixelHeight = 7;

    uint8_t x1 = x - thickness;
	uint16_t y1 = y - thickness;
	
	uint8_t x2 = x + numPixelWidth;
	uint16_t y2 = y + numPixelHeight;


	fillRectangle(x1, y1, numPixelWidth + thickness*2, thickness, colour); // top
	fillRectangle(x1, y, thickness, numPixelHeight + thickness, colour); // left
	fillRectangle(x2, y, thickness, numPixelHeight + thickness, colour); // right
	fillRectangle(x, y2, numPixelWidth, thickness, colour); // bottom
}

// Returns the pixel colour of the background image based on the given X, Y cords 
uint16_t getBackgroundPixel(uint16_t screenX, uint16_t screenY){
	uint16_t colour = 0;

	if (screenY >= bStart && screenY < (bStart + bHeight)) { // check if x, y are within the background cords
		uint8_t index = screenX % bWidth; // column of the x pixel
		uint16_t backgroundIndex = (screenY - bStart) * bWidth + index; // (index of y * row of y pixel) + column of x pixel

		colour = backgroundIMG[backgroundIndex];
	}

	else if (screenY < bStart) colour = skyColour; // if y cords are more than background y, colour = sky 
	else if (screenY >= bStart + bHeight) colour = soilColour; // if y cords are less than background y, colour = soil

	else colour = 0;

	return colour;
}

uint8_t anyButtonPressed(){
	return (downPressed() || upPressed() || leftPressed() || rightPressed() || enterPressed()) ? 1 : 0;
}

uint8_t downPressed(){
	return ((GPIOA->IDR & (1 << 11)) == 0) ? 1 : 0;
}

uint8_t upPressed(){
	return ((GPIOA->IDR & (1 << 8)) == 0) ? 1 : 0;
}

uint8_t rightPressed(){
	return ((GPIOB->IDR & (1 << 4))==0) ? 1 : 0;
}

uint8_t leftPressed(){
	return ((GPIOB->IDR & (1 << 5))==0) ? 1 : 0;
}

uint8_t enterPressed(){
	return ((GPIOA->IDR & (1 << 1))==0) ? 1 : 0;
}

// Function for checking if a button gets pressed only once, avoids button holding
uint8_t enterPressedOnce() {
	static uint8_t prevEnterState = 0; // previous state of the button

    uint8_t currState = ((GPIOA->IDR & (1 << 1)) == 0) ? 1 : 0; // if button gets pressed, 1, else 0
    uint8_t pressed = (currState == 1 && prevEnterState == 0); // if button is pressed and hasn't been pressed before
    prevEnterState = currState;

    return pressed;
}

void initSysTick(void)
{
	SysTick->LOAD = 48000;
	SysTick->CTRL = 7;
	SysTick->VAL = 10;
	__asm(" cpsie i "); // enable interrupts
}

void SysTick_Handler(void)
{
	milliseconds++;
}

void initClock(void)
{
	// This is potentially a dangerous function as it could
	// result in a system with an invalid clock signal - result: a stuck system
	// Set the PLL up
	// First ensure PLL is disabled
	RCC->CR &= ~(1u<<24);
	while( (RCC->CR & (1 <<25))); // wait for PLL ready to be cleared
        
	// Warning here: if system clock is greater than 24MHz then wait-state(s) need to be
	// inserted into Flash memory interface
	FLASH->ACR |= (1 << 0);
	FLASH->ACR &=~((1u << 2) | (1u<<1));

	// Turn on FLASH prefetch buffer
	FLASH->ACR |= (1 << 4);

	// set PLL multiplier to 12 (yielding 48MHz)
	RCC->CFGR &= ~((1u<<21) | (1u<<20) | (1u<<19) | (1u<<18));
	RCC->CFGR |= ((1<<21) | (1<<19) ); 

	// Need to limit ADC clock to below 14MHz so will change ADC prescaler to 4
	RCC->CFGR |= (1<<14);

	// and turn the PLL back on again
	RCC->CR |= (1<<24);        
	// set PLL as system clock source 
	RCC->CFGR |= (1<<1);
}
void delay(volatile uint32_t dly)
{
	uint32_t end_time = dly + milliseconds;
	while(milliseconds != end_time)
		__asm(" wfi "); // sleep
}

// enables the pull-ul resistor for a specifified GPIO pin
void enablePullUp(GPIO_TypeDef *Port, uint32_t BitNumber)
{
	Port->PUPDR = Port->PUPDR &~(3u << BitNumber*2); // clear pull-up resistor bits
	Port->PUPDR = Port->PUPDR | (1u << BitNumber*2); // set pull-up bit
}

// sets the mode of a specific GPIO pin on the microcontroller
void pinMode(GPIO_TypeDef *Port, uint32_t BitNumber, uint32_t Mode)
{
	uint32_t mode_value = Port->MODER; // checks the current value of the MODER register for a specified GPIO port
	Mode = Mode << (2 * BitNumber); // left-shifts Mode value by 2 inorder to prepare mode_value to be inserted into its bit position in MODER
	mode_value = mode_value & ~(3u << (BitNumber * 2)); // clears the bits for configuring the mode of given GPIO pins
	mode_value = mode_value | Mode; // sets the two bits for the given GPIO pin with mode_value
	Port->MODER = mode_value; // write mode_value back into MODER register
}

// congiures the microcontroller's GPIO pins for input mode
void setupIO()
{
	RCC->AHBENR |= (1 << 18) + (1 << 17); // enable Ports A and B
	display_begin();
	pinMode(GPIOA,1,0);
	pinMode(GPIOB,4,0);
	pinMode(GPIOB,5,0);
	pinMode(GPIOA,8,0);
	pinMode(GPIOA,11,0);
	enablePullUp(GPIOA,1);
	enablePullUp(GPIOB,4);
	enablePullUp(GPIOB,5);
	enablePullUp(GPIOA,11);
	enablePullUp(GPIOA,8);
}
